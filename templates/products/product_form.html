{% extends 'base.html' %}
{% load l10n %}

{% block title %}{% if product %}Editar Producto{% else %}Crear Producto{% endif %}{% endblock %}

{% block extra_styles %}
<style>
    .field-error {
        border-color: #DC2626 !important;
        border-width: 2px !important;
    }

    .error-message {
        color: #DC2626;
        font-size: 0.75rem;
        margin-top: 0.25rem;
        font-weight: 500;
        letter-spacing: 0.3px;
        display: none;
    }

    .error-message.show {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Header -->
    <div class="mb-12">
        <h1 class="editorial-title mb-3" style="color: var(--dark-brown);">
            {% if product %}Editar Producto{% else %}Nueva Fragancia{% endif %}
        </h1>
        <p class="text-base" style="color: var(--soft-gray); letter-spacing: 0.5px;">
            {% if product %}Actualiza los detalles de este producto{% else %}Agrega una nueva fragancia a la colección{% endif %}
        </p>
    </div>

    <!-- Form -->
    <form method="POST" enctype="multipart/form-data" class="minimal-card p-10">
        {% csrf_token %}

        <!-- Información Básica -->
        <div class="mb-12 pb-12" style="border-bottom: 1px solid var(--beige);">
            <h2 class="serif text-2xl mb-8" style="color: var(--dark-brown); font-weight: 600; letter-spacing: 1px;">
                Información Básica
            </h2>

            <div class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="name" class="block text-xs font-medium mb-3" style="color: var(--soft-gray); letter-spacing: 1.5px; text-transform: uppercase;">
                            Nombre del Producto <span style="color: #DC2626;">*</span>
                        </label>
                        <input type="text" name="name" id="name" required
                               value="{% if product %}{{ product.name }}{% endif %}"
                               placeholder="Ej: Bleu de Chanel"
                               class="w-full px-4 py-3 border rounded text-base"
                               style="border-color: var(--beige); background-color: white; color: var(--charcoal);">
                        <span class="error-message" id="name-error">Este campo es obligatorio</span>
                    </div>

                    <div>
                        <label for="brand" class="block text-xs font-medium mb-3" style="color: var(--soft-gray); letter-spacing: 1.5px; text-transform: uppercase;">
                            Marca <span style="color: #DC2626;">*</span>
                        </label>
                        <input type="text" name="brand" id="brand" required
                               value="{% if product %}{{ product.brand }}{% endif %}"
                               placeholder="Ej: Chanel"
                               class="w-full px-4 py-3 border rounded text-base"
                               style="border-color: var(--beige); background-color: white; color: var(--charcoal);">
                        <span class="error-message" id="brand-error">Este campo es obligatorio</span>
                    </div>
                </div>

                <div>
                    <label for="description" class="block text-xs font-medium mb-3" style="color: var(--soft-gray); letter-spacing: 1.5px; text-transform: uppercase;">
                        Descripción <span style="color: #DC2626;">*</span>
                    </label>
                    <textarea name="description" id="description" rows="4" required
                              placeholder="Describe las características y notas del producto..."
                              class="w-full px-4 py-3 border rounded text-base"
                              style="border-color: var(--beige); background-color: white; color: var(--charcoal);">{% if product %}{{ product.description }}{% endif %}</textarea>
                    <span class="error-message" id="description-error">Este campo es obligatorio</span>
                </div>
            </div>
        </div>

        <!-- Categorización -->
        <div class="mb-12 pb-12" style="border-bottom: 1px solid var(--beige);">
            <h2 class="serif text-2xl mb-8" style="color: var(--dark-brown); font-weight: 600; letter-spacing: 1px;">
                Categorización
            </h2>

            <div class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="category" class="block text-xs font-medium mb-3" style="color: var(--soft-gray); letter-spacing: 1.5px; text-transform: uppercase;">
                            Categoría <span style="color: #DC2626;">*</span>
                        </label>
                        <select name="category" id="category" required
                                class="w-full px-4 py-3 border rounded text-base"
                                style="border-color: var(--beige); background-color: white; color: var(--charcoal);">
                            <option value="">Seleccionar...</option>
                            <option value="PERFUME" {% if product and product.category == 'PERFUME' %}selected{% endif %}>Perfume</option>
                            <option value="EDT" {% if product and product.category == 'EDT' %}selected{% endif %}>Eau de Toilette</option>
                            <option value="EDC" {% if product and product.category == 'EDC' %}selected{% endif %}>Eau de Cologne</option>
                            <option value="EDP" {% if product and product.category == 'EDP' %}selected{% endif %}>Eau de Parfum</option>
                            <option value="BODY_SPRAY" {% if product and product.category == 'BODY_SPRAY' %}selected{% endif %}>Body Spray</option>
                            <option value="LOTION" {% if product and product.category == 'LOTION' %}selected{% endif %}>Loción Corporal</option>
                            <option value="CREAM" {% if product and product.category == 'CREAM' %}selected{% endif %}>Crema</option>
                            <option value="GEL" {% if product and product.category == 'GEL' %}selected{% endif %}>Gel</option>
                            <option value="DEODORANT" {% if product and product.category == 'DEODORANT' %}selected{% endif %}>Desodorante</option>
                            <option value="OTHER" {% if product and product.category == 'OTHER' %}selected{% endif %}>Otro</option>
                        </select>
                        <span class="error-message" id="category-error">Debe seleccionar una categoría</span>
                    </div>

                    <div>
                        <label for="gender" class="block text-xs font-medium mb-3" style="color: var(--soft-gray); letter-spacing: 1.5px; text-transform: uppercase;">
                            Género <span style="color: #DC2626;">*</span>
                        </label>
                        <select name="gender" id="gender" required
                                class="w-full px-4 py-3 border rounded text-base"
                                style="border-color: var(--beige); background-color: white; color: var(--charcoal);">
                            <option value="">Seleccionar...</option>
                            <option value="M" {% if product and product.gender == 'M' %}selected{% endif %}>Masculino</option>
                            <option value="F" {% if product and product.gender == 'F' %}selected{% endif %}>Femenino</option>
                            <option value="U" {% if product and product.gender == 'U' %}selected{% endif %}>Unisex</option>
                        </select>
                        <span class="error-message" id="gender-error">Debe seleccionar un género</span>
                    </div>

                    <div>
                        <label for="fragrance_type" class="block text-xs font-medium mb-3" style="color: var(--soft-gray); letter-spacing: 1.5px; text-transform: uppercase;">
                            Tipo de Fragancia
                        </label>
                        <select name="fragrance_type" id="fragrance_type"
                                class="w-full px-4 py-3 border rounded text-base"
                                style="border-color: var(--beige); background-color: white; color: var(--charcoal);">
                            <option value="">Seleccionar...</option>
                            <option value="FLORAL" {% if product and product.fragrance_type == 'FLORAL' %}selected{% endif %}>Floral</option>
                            <option value="ORIENTAL" {% if product and product.fragrance_type == 'ORIENTAL' %}selected{% endif %}>Oriental</option>
                            <option value="WOODY" {% if product and product.fragrance_type == 'WOODY' %}selected{% endif %}>Amaderado</option>
                            <option value="FRESH" {% if product and product.fragrance_type == 'FRESH' %}selected{% endif %}>Fresco</option>
                            <option value="CITRUS" {% if product and product.fragrance_type == 'CITRUS' %}selected{% endif %}>Cítrico</option>
                            <option value="FRUITY" {% if product and product.fragrance_type == 'FRUITY' %}selected{% endif %}>Frutal</option>
                            <option value="SPICY" {% if product and product.fragrance_type == 'SPICY' %}selected{% endif %}>Especiado</option>
                            <option value="AQUATIC" {% if product and product.fragrance_type == 'AQUATIC' %}selected{% endif %}>Acuático</option>
                            <option value="GOURMAND" {% if product and product.fragrance_type == 'GOURMAND' %}selected{% endif %}>Gourmand</option>
                            <option value="OTHER" {% if product and product.fragrance_type == 'OTHER' %}selected{% endif %}>Otro</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label for="volume" class="block text-xs font-medium mb-3" style="color: var(--soft-gray); letter-spacing: 1.5px; text-transform: uppercase;">
                        Volumen (ml) <span style="color: #DC2626;">*</span>
                    </label>
                    <input type="number" name="volume" id="volume" required
                           value="{% if product %}{{ product.volume }}{% endif %}"
                           placeholder="100"
                           class="w-full px-4 py-3 border rounded text-base"
                           style="border-color: var(--beige); background-color: white; color: var(--charcoal);">
                    <span class="error-message" id="volume-error">Este campo es obligatorio</span>
                </div>
            </div>
        </div>

        <!-- Precios e Inventario -->
        <div class="mb-12 pb-12" style="border-bottom: 1px solid var(--beige);">
            <h2 class="serif text-2xl mb-8" style="color: var(--dark-brown); font-weight: 600; letter-spacing: 1px;">
                Precios e Inventario
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div>
                    <label for="cost" class="block text-xs font-medium mb-3" style="color: var(--soft-gray); letter-spacing: 1.5px; text-transform: uppercase;">
                        Costo
                    </label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-base" style="color: var(--soft-gray);">$</span>
                        <input type="number" name="cost" id="cost" step="0.01" min="0"
                               value="{% if product %}{{ product.cost|unlocalize }}{% else %}0{% endif %}"
                               class="w-full pl-10 pr-4 py-3 border rounded text-base"
                               style="border-color: var(--beige); background-color: white; color: var(--charcoal);">
                    </div>
                </div>

                <div>
                    <label for="price" class="block text-xs font-medium mb-3" style="color: var(--soft-gray); letter-spacing: 1.5px; text-transform: uppercase;">
                        Precio de Venta <span style="color: #DC2626;">*</span>
                    </label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-base" style="color: var(--soft-gray);">$</span>
                        <input type="number" name="price" id="price" step="0.01" required min="0"
                               value="{% if product %}{{ product.price|unlocalize }}{% endif %}"
                               class="w-full pl-10 pr-4 py-3 border rounded text-base"
                               style="border-color: var(--beige); background-color: white; color: var(--charcoal);">
                    </div>
                    <span class="error-message" id="price-error">Este campo es obligatorio</span>
                </div>

                <div>
                    <label for="quantity" class="block text-xs font-medium mb-3" style="color: var(--soft-gray); letter-spacing: 1.5px; text-transform: uppercase;">
                        Cantidad en Stock <span style="color: #DC2626;">*</span>
                    </label>
                    <input type="number" name="quantity" id="quantity" required min="0"
                           value="{% if product %}{{ product.quantity }}{% endif %}"
                           class="w-full px-4 py-3 border rounded text-base"
                           style="border-color: var(--beige); background-color: white; color: var(--charcoal);">
                    <span class="error-message" id="quantity-error">Este campo es obligatorio</span>
                </div>

                <div>
                    <label for="min_stock" class="block text-xs font-medium mb-3" style="color: var(--soft-gray); letter-spacing: 1.5px; text-transform: uppercase;">
                        Stock Mínimo
                    </label>
                    <input type="number" name="min_stock" id="min_stock" min="0"
                           value="{% if product %}{{ product.min_stock }}{% else %}5{% endif %}"
                           class="w-full px-4 py-3 border rounded text-base"
                           style="border-color: var(--beige); background-color: white; color: var(--charcoal);">
                </div>
            </div>
        </div>

        <!-- Identificadores y Proveedor -->
        <div class="mb-12 pb-12" style="border-bottom: 1px solid var(--beige);">
            <h2 class="serif text-2xl mb-8" style="color: var(--dark-brown); font-weight: 600; letter-spacing: 1px;">
                Identificadores y Proveedor
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="sku" class="block text-xs font-medium mb-3" style="color: var(--soft-gray); letter-spacing: 1.5px; text-transform: uppercase;">
                        SKU <span style="color: #DC2626;">*</span>
                    </label>
                    <input type="text" name="sku" id="sku" required
                           value="{% if product %}{{ product.sku }}{% endif %}"
                           placeholder="PERF-CHANEL-100"
                           class="w-full px-4 py-3 border rounded text-base font-mono"
                           style="border-color: var(--beige); background-color: white; color: var(--charcoal);">
                    <span class="error-message" id="sku-error">Este campo es obligatorio</span>
                </div>

                <div>
                    <label for="barcode" class="block text-xs font-medium mb-3" style="color: var(--soft-gray); letter-spacing: 1.5px; text-transform: uppercase;">
                        Código de Barras
                    </label>
                    <input type="text" name="barcode" id="barcode"
                           value="{% if product %}{{ product.barcode }}{% endif %}"
                           placeholder="7891234567890"
                           class="w-full px-4 py-3 border rounded text-base font-mono"
                           style="border-color: var(--beige); background-color: white; color: var(--charcoal);">
                </div>

                <div>
                    <label for="supplier" class="block text-xs font-medium mb-3" style="color: var(--soft-gray); letter-spacing: 1.5px; text-transform: uppercase;">
                        Proveedor
                    </label>
                    <input type="text" name="supplier" id="supplier"
                           value="{% if product %}{{ product.supplier }}{% endif %}"
                           placeholder="Distribuidora XYZ"
                           class="w-full px-4 py-3 border rounded text-base"
                           style="border-color: var(--beige); background-color: white; color: var(--charcoal);">
                </div>
            </div>
        </div>

        <!-- Imagen -->
        <div class="mb-12">
            <h2 class="serif text-2xl mb-8" style="color: var(--dark-brown); font-weight: 600; letter-spacing: 1px;">
                Imagen del Producto
            </h2>

            <div class="grid grid-cols-1 gap-6">
                <div>
                    <label for="image" class="block text-xs font-medium mb-3" style="color: var(--soft-gray); letter-spacing: 1.5px; text-transform: uppercase;">
                        Imagen del Producto
                    </label>
                    <input type="file" name="image" id="image" accept="image/*"
                           class="w-full px-4 py-3 border rounded text-base"
                           style="border-color: var(--beige); background-color: white; color: var(--charcoal);">
                    {% if product and product.image %}
                    <div class="mt-4 p-4 rounded" style="background-color: var(--ivory); border: 1px solid var(--beige);">
                        <img src="{{ product.image.url }}" alt="{{ product.name }}" class="h-32 w-32 object-cover rounded mx-auto">
                        <p class="text-xs text-center mt-2" style="color: var(--soft-gray);">Imagen actual</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Botones -->
        <div class="pt-8 space-y-4" style="border-top: 1px solid var(--beige);">
            <button type="submit"
                    class="minimal-btn w-full px-6 py-4 rounded text-lg"
                    style="background-color: var(--soft-brown); color: white;">
                {% if product %}Guardar Cambios{% else %}Crear Producto{% endif %}
            </button>
            <a href="{% url 'product_list' %}"
               class="minimal-btn w-full px-6 py-3 rounded text-center block"
               style="background-color: var(--ivory); color: var(--dark-brown); border: 1px solid var(--beige);">
                Cancelar
            </a>
        </div>

        <p class="text-xs text-center mt-6" style="color: var(--soft-gray); letter-spacing: 0.5px;">
            <span style="color: #DC2626;">*</span> Campos obligatorios
        </p>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Obtener todos los campos requeridos
    const requiredFields = document.querySelectorAll('[required]');

    requiredFields.forEach(function(field) {
        // Validación al perder el foco (blur)
        field.addEventListener('blur', function() {
            validateField(this);
        });

        // Limpiar error al empezar a escribir/seleccionar
        field.addEventListener('input', function() {
            clearError(this);
        });

        // Para select, también escuchar el evento change
        if (field.tagName === 'SELECT') {
            field.addEventListener('change', function() {
                clearError(this);
            });
        }
    });

    function validateField(field) {
        const fieldId = field.id;
        const errorMessage = document.getElementById(fieldId + '-error');

        if (!errorMessage) return;

        // Verificar si el campo está vacío
        let isEmpty = false;

        if (field.tagName === 'SELECT') {
            isEmpty = field.value === '';
        } else if (field.tagName === 'TEXTAREA') {
            isEmpty = field.value.trim() === '';
        } else {
            isEmpty = field.value.trim() === '';
        }

        if (isEmpty) {
            field.classList.add('field-error');
            errorMessage.classList.add('show');
        }
    }

    function clearError(field) {
        const fieldId = field.id;
        const errorMessage = document.getElementById(fieldId + '-error');

        if (!errorMessage) return;

        // Verificar si el campo tiene valor
        let hasValue = false;

        if (field.tagName === 'SELECT') {
            hasValue = field.value !== '';
        } else if (field.tagName === 'TEXTAREA') {
            hasValue = field.value.trim() !== '';
        } else {
            hasValue = field.value.trim() !== '';
        }

        if (hasValue) {
            field.classList.remove('field-error');
            errorMessage.classList.remove('show');
        }
    }

    // Validar todos los campos al intentar enviar el formulario
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        let hasErrors = false;

        requiredFields.forEach(function(field) {
            validateField(field);

            if (field.classList.contains('field-error')) {
                hasErrors = true;
            }
        });

        if (hasErrors) {
            e.preventDefault();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    });
});
</script>
{% endblock %}
